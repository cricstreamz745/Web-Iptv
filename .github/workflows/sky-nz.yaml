name: Extract MPD URL and Clear Keys

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

jobs:
  extract-stream-info:
    runs-on: ubuntu-latest
    
    steps:
    - name: Fetch HTML content
      id: fetch
      run: |
        response=$(curl -s -H "Referer: https://webiptv.site/" \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
          https://webiptv.site/skynz1.php)
        echo "html_content<<EOF" >> $GITHUB_ENV
        echo "$response" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
    - name: Extract information from HTML
      id: extract
      run: |
        # Extract the fetch URL from JavaScript
        fetch_url=$(echo "${{ env.html_content }}" | grep -o 'https://mpdchecker.webiptv.site/output.php[^"]*' | head -1)
        
        # Extract the clear keys from DRM config
        clear_keys=$(echo "${{ env.html_content }}" | grep -o 'clearKeys: {[^}]*}' | sed 's/clearKeys: //')
        
        # Extract the MPD URL from the fetch URL (if it exists)
        mpd_url=""
        if [ ! -z "$fetch_url" ]; then
          # URL decode the parameter
          mpd_url=$(echo "$fetch_url" | sed 's/.*url=//' | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))")
        fi
        
        # Create JSON output
        cat > extracted_info.json << EOF
        {
          "page_url": "https://webiptv.site/skynz1.php",
          "fetch_url": "$fetch_url",
          "mpd_url": "$mpd_url",
          "clear_keys": $clear_keys,
          "extraction_time": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        }
        EOF
        
        echo "JSON created successfully!"
        cat extracted_info.json
        
        # Set outputs for the workflow
        echo "fetch_url=$fetch_url" >> $GITHUB_OUTPUT
        echo "mpd_url=$mpd_url" >> $GITHUB_OUTPUT
        
    - name: Upload extracted JSON
      uses: actions/upload-artifact@v4
      with:
        name: extracted-stream-info
        path: extracted_info.json
        
    - name: Save to workflow summary
      run: |
        echo "## Extracted Stream Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Page URL:** ${{ steps.extract.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Fetch URL:**" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.extract.outputs.fetch_url }}" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**MPD URL:**" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.extract.outputs.mpd_url }}" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Clear Keys:**" >> $GITHUB_STEP_SUMMARY
        echo "```json" >> $GITHUB_STEP_SUMMARY
        echo "$(cat extracted_info.json | jq -r '.clear_keys')" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        
    - name: Commit and push if changed
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add extracted_info.json
        git commit -m "Update extracted stream info $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push
